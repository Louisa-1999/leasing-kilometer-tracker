<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leasing‑Kilometer Tracker</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Konfiguriere Tailwind, damit der Dark‑Mode per Klasse gesteuert wird
      tailwind.config = {
        darkMode: 'class',
      };
    </script>
    <style>
        /*
          Ein schlichtes und responsives Layout.  Die Seite ist zweispaltig
          aufgebaut: links die Eingabefelder zur Berechnung, rechts die
          Ergebnisse, Planungs‑Tools und die grafische Übersicht. Auf kleinen
          Displays werden die Spalten untereinander angeordnet.
        */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
                sans-serif;
            /* Hintergrund und Textfarben werden über Tailwind‑Klassen auf dem
               <body>‑Element gesetzt (z. B. bg-gray-50, dark:bg-gray-900).  Die
               folgenden Eigenschaften werden entfernt, damit sie die
               Tailwind‑Einstellungen nicht überschreiben. */
            margin: 0;
            padding: 0;
        }

        nav {
            /* Das Styling der Navigationsleiste wird über Tailwind‑Klassen
               definiert. Hier halten wir lediglich den unteren Abstand bei,
               damit die Section nicht zu nah an den nachfolgenden Inhalten
               klebt. */
            margin-bottom: 24px;
        }
        nav span {
            /* Der Farbton des Titels ist in den Tailwind‑Klassen bereits
               festgelegt (text-blue‑600 und dark:text-blue‑400). Die Angabe
               unten ist optional und kann entfernt werden, wird aber hier
               belassen, da sie identisch ist. */
            color: #0366d6;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            /* Die Hintergrundfarbe und der Rahmen der Containerbox werden durch
               Tailwind‑Klassen auf dem <div> (bg-white, dark:bg-gray-800,
               border, dark:border-gray-700) gesteuert.  Hier definierte
               Farben würden den Dark‑Mode überschreiben, daher werden sie
               entfernt. */
            padding: 32px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .flex-container {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        .column {
            flex: 1;
            min-width: 0;
        }
        @media (max-width: 900px) {
            .flex-container {
                flex-direction: column;
            }
        }

        h1 {
            font-size: 28px;
            margin: 0 0 20px;
            text-align: center;
        }
        h2 {
            font-size: 22px;
            margin: 24px 0 12px;
        }
        h3 {
            font-size: 18px;
            margin: 24px 0 12px;
        }

        p.intro {
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.5;
        }

        label {
            display: block;
            margin-top: 16px;
            font-weight: bold;
        }

        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 15px;
            box-sizing: border-box;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            margin: 0;
        }

        button {
            margin-top: 24px;
            padding: 12px 20px;
            background: #008c9e;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
        }
        button:hover {
            background: #007686;
        }

        .result {
            margin-top: 16px;
            padding: 16px;
            /* Die Hintergrundfarbe und der Rahmen des Ergebnisblocks werden
               ebenfalls durch Tailwind‑Klassen auf dem <div> gesetzt.  Die
               folgenden Angaben würden im Dark‑Mode zu einem weißen Block
               führen und werden deshalb entfernt. */
            border-radius: 4px;
        }
        .result p {
            margin: 6px 0;
            font-size: 15px;
            line-height: 1.4;
        }
        .success {
            color: #2d9c5b;
        }
        .warning {
            color: #d9534f;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        table th,
        table td {
            padding: 8px;
            border-bottom: 1px solid #ccc;
            text-align: left;
            font-size: 14px;
        }

        .chart-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .chart-label {
            width: 80px;
            font-size: 12px;
            text-transform: capitalize;
        }
        .chart-bars {
            display: flex;
            flex-grow: 1;
            height: 18px;
            position: relative;
        }
        .chart-bars .bar {
            height: 100%;
            margin-right: 2px;
        }
        .bar.allowed {
            background: #e0e0e0;
        }
        .bar.planned {
            background: #4ba3c7;
        }
        .bar.actual {
            background: #2d9c5b;
        }

        .legend {
            display: flex;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 16px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 4px;
        }
        /* Responsivität für kleine Bildschirme */
        @media (max-width: 600px) {
            .container {
                padding: 24px 16px;
            }
            h1 {
                font-size: 24px;
            }
            p.intro {
                font-size: 14px;
            }
            .chart-label {
                width: 60px;
                font-size: 10px;
            }
            .chart-bars {
                height: 14px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-200">
    <!-- Navigationsbereich mit Dark-Mode-Toggle -->
    <nav class="flex items-center justify-between px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <span class="text-blue-600 dark:text-blue-400 font-bold">Kilometerrechner&nbsp;&amp;&nbsp;Planung</span>
        <!-- Dark‑Mode‑Schalter: beim Umschalten wird die Klasse 'dark' auf dem HTML‑Element gesetzt -->
        <label for="darkToggle" class="flex items-center cursor-pointer select-none">
            <input type="checkbox" id="darkToggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:bg-blue-600 relative">
                <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
            </div>
            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Dark&nbsp;Mode</span>
        </label>
    </nav>
    <!--
      Die äußere Container‑Box erhält Tailwind‑Klassen für einen hellen Hintergrund
      im Light‑Mode und einen dunklen Hintergrund im Dark‑Mode, sowie einen
      Rahmen und Schatten. Dadurch erscheint die Box auf beiden Themen
      kontrastreich und der Dark‑Mode zeigt keinen weißen Hintergrund.
    -->
    <div class="container mx-auto max-w-7xl px-4 py-8 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Linke Spalte: Eingaben zur Berechnung -->
            <div class="column w-full lg:w-1/2" id="calculatorColumn">
                <h1>Leasing‑Kilometer Tracker</h1>
                <p class="intro">
                    Dieses Tool hilft dir, deinen Kilometerverbrauch basierend auf deinem
                    Leasingvertrag zu verfolgen. Gib einfach die relevanten Daten ein, um zu
                    sehen, wie viele Kilometer dir insgesamt und innerhalb des aktuellen
                    Monats noch zur Verfügung stehen.
                </p>
                <label for="annualLimit">Jahreskilometer‑Limit (km)</label>
                <input type="number" id="annualLimit" placeholder="z. B. 40000" value="40000" min="1" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                <label for="startDate">Startdatum des Leasingvertrags</label>
                <input type="date" id="startDate" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                <label for="startOdometer">Kilometerstand zu Beginn des Leasingvertrags</label>
                <input type="number" id="startOdometer" placeholder="Start‑Kilometerstand" min="0" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                <label for="currentDate">Aktuelles Datum</label>
                <input type="date" id="currentDate" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                <label for="currentOdometer">Aktueller Kilometerstand</label>
                <input type="number" id="currentOdometer" placeholder="Aktueller Kilometerstand" min="0" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />

                <!-- Leasingdauer: Anzahl der Monate des Leasingvertrags -->
                <label for="leaseDuration">Leasingdauer&nbsp;(Monate)</label>
                <!--
                  Ermöglicht das Festlegen der Vertragslaufzeit in Monaten, zum Beispiel
                  48&nbsp;Monate. Dadurch kann die Planung alle Monate des Vertrags
                  umfassen und nicht nur ein einzelnes Jahr.
                -->
                <input type="number" id="leaseDuration" min="1" placeholder="z.&nbsp;B.&nbsp;48" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                <label for="monthStartOdometer">Kilometerstand am Monatsanfang (optional)</label>
                <input type="number" id="monthStartOdometer" placeholder="Kilometerstand zu Beginn des Monats" min="0" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                <button id="calculate" class="mt-6 bg-teal-600 hover:bg-teal-700 text-white font-semibold px-4 py-2 rounded">Berechnen</button>

                <!-- Ergebnisse werden direkt unter den Eingaben angezeigt -->
                <div id="results" class="result mt-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4 rounded"></div>
            </div>
            <!-- Rechte Spalte: Planung und Diagramm -->
            <div class="column w-full lg:w-1/2" id="planningColumn">
                <div id="planningSection" style="display: none;">
                    <h2>Fahrten planen</h2>
                    <p>Hier kannst du Strecken hinzufügen, die du im verbleibenden Monat fahren möchtest – zum Beispiel die 150 km lange Fahrt zur Arbeit oder die 400 km zu deiner Mutter. Das Tool errechnet automatisch, ob dein aktuelles Monatsbudget dafür ausreicht.</p>
                    <!-- Außerordentliche Fahrten (einmalig) -->
                    <!--
                      In diesem Abschnitt kannst du Fahrten eintragen, die nur einmal oder selten
                      im aktuellen Monat stattfinden – zum Beispiel eine längere Reise oder ein
                      spontaner Ausflug. Gib die Streckenlänge und wie oft du diese Fahrt im
                      laufenden Monat durchführen möchtest ein. Bei einer einzigen Fahrt lässt
                      du die Anzahl auf 1.
                    -->
                    <label for="tripDistance">Streckenlänge außerordentliche Fahrt (km)</label>
                    <input type="number" id="tripDistance" min="0" placeholder="z. B. 150 oder 400" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                    <label for="tripCount">Anzahl dieser Fahrten im Monat</label>
                    <input type="number" id="tripCount" min="1" placeholder="z. B. 1" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                    <button id="addTrip">Hinzufügen</button>
                    <div id="tripListContainer" style="margin-top: 24px;"></div>
                    <div id="planningSummary" style="margin-top: 24px;"></div>
                    <!-- Regelmäßige Fahrten (monatlich) -->
                    <h3>Regelmäßige Fahrten</h3>
                    <p>Hier kannst du Fahrten erfassen, die regelmäßig während des Monats anfallen –
                        beispielsweise die Fahrt zur Arbeit oder der wöchentliche Einkauf. Gib die
                        Streckenlänge einer einzelnen Fahrt an und wie oft sie im aktuellen Monat
                        stattfinden wird (zum Beispiel 4 oder 2 mal).</p>
                    <label for="regularDistance">Streckenlänge pro Fahrt (km)</label>
                    <input type="number" id="regularDistance" min="0" placeholder="z. B. 150" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                    <label for="regularCount">Anzahl der Fahrten im Monat</label>
                    <input type="number" id="regularCount" min="0" value="0" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
                    <button id="calculateRegularPlan">Berechnen</button>
                    <div id="regularPlanResults" style="margin-top: 24px;"></div>
                    <!-- Monatliche Planung über die gesamte Vertragslaufzeit -->
                    <h3>Monatliche Planung</h3>
                    <p>Plane dein Kilometerbudget für jeden Monat deiner Leasinglaufzeit. Die Tabelle unten zeigt nur die Monate des aktuell ausgewählten Jahres. Wähle ein Jahr aus und trage für die einzelnen Monate die außerordentlichen Kilometer ein.</p>
                    <!-- Jahresauswahl: wird dynamisch mit den Jahren des Vertrags gefüllt -->
                    <label for="yearSelector">Jahr auswählen:</label>
                    <!-- Der Jahres‑Dropdown erhält Tailwind‑Klassen, damit er im Dark‑Mode nicht weiß erscheint. -->
                    <select id="yearSelector" class="w-full mt-1 p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" style="margin-bottom:12px;"></select>
                    <table id="monthlyPlanTable"></table>
                    <div id="monthlyPlanSummary" style="margin-top: 16px;"></div>
                    <!-- Diagramm -->
                    <h3>Grafische Übersicht</h3>
                    <div id="chartContainer"></div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background:#e0e0e0;"></div><span>Erlaubt</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:#4ba3c7;"></div><span>Geplant</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:#2d9c5b;"></div><span>Aktuell</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Globale Variablen für Planung
        let plannedTrips = [];
        let monthlyPlan = [];
        let remainingMonthKm = NaN;
        let remainingYearKm = NaN;
        let dailyLimit = NaN;
        let startDateGlobal = null;
        let currentDateGlobal = null;
        let leaseDurationGlobal = NaN;

        // Hilfsfunktion: formatiert Zahlen ohne Dezimalstellen
        function formatKm(value) {
            return isNaN(value) ? '–' : value.toFixed(0);
        }

        // Berechnet die Kilometerdaten und zeigt die Ergebnisse an
        function calculate() {
            const annualLimit = parseFloat(document.getElementById('annualLimit').value);
            const startDateVal = document.getElementById('startDate').value;
            const currentDateVal = document.getElementById('currentDate').value;
            const startOdometer = parseFloat(document.getElementById('startOdometer').value);
            const currentOdometer = parseFloat(document.getElementById('currentOdometer').value);
            const monthStartOdometerVal = document.getElementById('monthStartOdometer').value;
            // Eingaben prüfen
            if (!annualLimit || !startDateVal || !currentDateVal || isNaN(startOdometer) || isNaN(currentOdometer)) {
                alert('Bitte fülle alle erforderlichen Felder aus.');
                return;
            }
            const startDate = new Date(startDateVal);
            const currentDate = new Date(currentDateVal);
            // Leasingdauer aus dem Eingabefeld lesen; Standard 12 Monate, falls leer oder ungültig
            const leaseVal = document.getElementById('leaseDuration').value;
            leaseDurationGlobal = parseInt(leaseVal, 10);
            if (isNaN(leaseDurationGlobal) || leaseDurationGlobal <= 0) {
                leaseDurationGlobal = 12;
            }
            if (currentDate < startDate) {
                alert('Das aktuelle Datum muss nach dem Startdatum liegen.');
                return;
            }
            startDateGlobal = startDate;
            currentDateGlobal = currentDate;
            const oneDay = 24 * 60 * 60 * 1000;
            const daysSinceStart = Math.floor((currentDate - startDate) / oneDay);
            dailyLimit = annualLimit / 365;
            const allowedTotalToDate = dailyLimit * daysSinceStart;
            const actualTotalToDate = currentOdometer - startOdometer;
            const differenceTotal = allowedTotalToDate - actualTotalToDate;
            remainingYearKm = differenceTotal;
            // Monatsbudget berechnen
            let monthResults = '';
            let diffMonth = NaN;
            if (monthStartOdometerVal !== '') {
                const monthStartOdometer = parseFloat(monthStartOdometerVal);
                const kmUsedThisMonth = currentOdometer - monthStartOdometer;
                const monthStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const monthEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                const daysInMonth = Math.floor((monthEndDate - monthStartDate) / oneDay);
                const allowedMonthKm = dailyLimit * daysInMonth;
                diffMonth = allowedMonthKm - kmUsedThisMonth;
                monthResults =
                    '<p><strong>Monatliches Limit:</strong> ' + formatKm(allowedMonthKm) + '&nbsp;km</p>' +
                    '<p><strong>Gefahren in diesem Monat:</strong> ' + formatKm(kmUsedThisMonth) + '&nbsp;km</p>' +
                    '<p><strong>Übrige Kilometer für diesen Monat:</strong> ' + formatKm(diffMonth) + '&nbsp;km</p>';
            } else {
                // Ohne Monatssstart: geschätztes Monatsbudget basierend auf verbleibendem Jahresbudget und verbleibenden Monaten
                const currentMonthIndex = currentDate.getMonth();
                const monthsLeftIncludingCurrent = 12 - currentMonthIndex;
                const divisor = monthsLeftIncludingCurrent > 0 ? monthsLeftIncludingCurrent : 1;
                diffMonth = differenceTotal / divisor;
                const monthStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const monthEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                const daysInMonth = Math.floor((monthEndDate - monthStartDate) / oneDay);
                const allowedMonthKm = dailyLimit * daysInMonth;
                monthResults =
                    '<p><strong>Monatliches Limit (berechnet):</strong> ' + formatKm(allowedMonthKm) + '&nbsp;km</p>' +
                    '<p><strong>Geschätztes verbleibendes Monatsbudget:</strong> ' + formatKm(diffMonth) + '&nbsp;km</p>' +
                    '<p><em>Dies ist eine Schätzung basierend auf deinem verbleibenden Jahresbudget und den verbleibenden Monaten.</em></p>';
            }
            remainingMonthKm = diffMonth;
            // Ergebnisse zusammenstellen
            let resultHtml = '';
            resultHtml += '<p><strong>Tage seit Vertragsbeginn:</strong> ' + daysSinceStart + '&nbsp;Tage</p>';
            resultHtml += '<p><strong>Zugelassene Kilometer bis heute:</strong> ' + formatKm(allowedTotalToDate) + '&nbsp;km</p>';
            resultHtml += '<p><strong>Gefahrene Kilometer seit Vertragsbeginn:</strong> ' + formatKm(actualTotalToDate) + '&nbsp;km</p>';
            if (differenceTotal >= 0) {
                resultHtml += '<p class="success"><strong>Du liegst unter deinem Limit.</strong> Du kannst noch ' + formatKm(differenceTotal) + '&nbsp;km fahren, um im Plan zu bleiben.</p>';
            } else {
                resultHtml += '<p class="warning"><strong>Du hast dein Limit überschritten.</strong> Du bist ' + formatKm(Math.abs(differenceTotal)) + '&nbsp;km über dem Plan.</p>';
            }
            resultHtml += monthResults;
            document.getElementById('results').innerHTML = resultHtml;
            // Planung aktivieren
            showPlanningSection(true);
            // Monatsplan initialisieren/aktualisieren für die komplette Vertragsdauer
            initMonthlyPlan();
            updateMonthlyPlanSummary();
            renderChart();
            // Planungsliste zurücksetzen
            plannedTrips = [];
            updatePlanningDisplay();
            // Speichere Eingaben und berechnete Werte in localStorage
            try {
                const dataToStore = {
                    annualLimit: document.getElementById('annualLimit').value,
                    startDate: startDateVal,
                    startOdometer: document.getElementById('startOdometer').value,
                    currentDate: currentDateVal,
                    currentOdometer: document.getElementById('currentOdometer').value,
                    monthStartOdometer: document.getElementById('monthStartOdometer').value,
                    remainingMonthKm: diffMonth,
                    remainingYearKm: differenceTotal,
                    monthlyPlan: monthlyPlan,
                    leaseDuration: leaseDurationGlobal
                };
                localStorage.setItem('leasingTrackerData', JSON.stringify(dataToStore));
            } catch (e) {
                // LocalStorage kann deaktiviert sein – ignoriere Fehler
            }
        }

        // Zeigt oder versteckt die Planungssektion
        function showPlanningSection(show) {
            const section = document.getElementById('planningSection');
            if (show) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        // Aktualisiert die Tabelle der geplanten einmaligen Fahrten und die Zusammenfassung
        function updatePlanningDisplay() {
            const listContainer = document.getElementById('tripListContainer');
            const summaryContainer = document.getElementById('planningSummary');
            if (!listContainer || !summaryContainer) return;
            if (plannedTrips.length === 0) {
                listContainer.innerHTML = '<p><em>Noch keine geplanten Fahrten hinzugefügt.</em></p>';
            } else {
                let html = '<table><thead><tr>';
                html += '<th>Strecke (km)</th><th>Fahrten</th><th>Gesamt (km)</th><th></th>';
                html += '</tr></thead><tbody>';
                plannedTrips.forEach((trip, index) => {
                    html += '<tr>';
                    html += '<td>' + formatKm(trip.distance) + '</td>';
                    html += '<td>' + trip.count + '</td>';
                    html += '<td>' + formatKm(trip.total) + '</td>';
                    // Verwende Tailwind‑Klassen für den Entfernen‑Button, damit er im Dark‑Mode konsistent aussieht
                    html += '<td><button class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 text-xs rounded" onclick="removeTrip(' + index + ')">Entfernen</button></td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
                listContainer.innerHTML = html;
            }
            // Zusammenfassung aktualisieren: Summe der geplanten Kilometer und verbleibendes Monatsbudget
            const totalPlanned = plannedTrips.reduce((sum, trip) => sum + trip.total, 0);
            let summaryHtml = '<p><strong>Geplante Kilometer insgesamt:</strong> ' + formatKm(totalPlanned) + '&nbsp;km</p>';
            if (!isNaN(remainingMonthKm)) {
                // Ermittle die geplanten regelmäßigen Kilometer des aktuellen Monats
                let currentRegular = 0;
                if (currentDateGlobal) {
                    const idx = monthlyPlan.findIndex(m => m.date.getFullYear() === currentDateGlobal.getFullYear() && m.date.getMonth() === currentDateGlobal.getMonth());
                    if (idx >= 0 && monthlyPlan[idx].regularKm) {
                        currentRegular = monthlyPlan[idx].regularKm;
                    }
                }
                const remainingAfter = remainingMonthKm - totalPlanned - currentRegular;
                summaryHtml += '<p><strong>Restliche Kilometer nach Planung:</strong> ' + formatKm(remainingAfter) + '&nbsp;km</p>';
                if (remainingAfter >= 0) {
                    summaryHtml += '<p class="success">Deine Planung passt in dein aktuelles Monatsbudget.</p>';
                } else {
                    summaryHtml += '<p class="warning">Achtung: Mit dieser Planung würdest du dein Monatsbudget überschreiten.</p>';
                }
            } else {
                summaryHtml += '<p><em>Keine Monatsbudgetdaten gefunden. Bitte berechne zuerst den Kilometerstand.</em></p>';
            }
            summaryContainer.innerHTML = summaryHtml;
        }

        // Fügt eine geplante einmalige Fahrt hinzu
        function addTrip() {
            const distanceInput = document.getElementById('tripDistance');
            const countInput = document.getElementById('tripCount');
            const distance = parseFloat(distanceInput.value);
            const count = parseInt(countInput.value, 10);
            if (isNaN(distance) || distance <= 0 || isNaN(count) || count <= 0) {
                alert('Bitte gib gültige Werte für Streckenlänge und Anzahl der Fahrten ein.');
                return;
            }
            const total = distance * count;
            plannedTrips.push({ distance: distance, count: count, total: total });
            // Eingabefelder zurücksetzen
            distanceInput.value = '';
            countInput.value = '';
            updatePlanningDisplay();
        }

        // Entfernt eine geplante einmalige Fahrt
        function removeTrip(index) {
            plannedTrips.splice(index, 1);
            updatePlanningDisplay();
        }

        // Berechnet die Kilometer für regelmäßige (monatliche) Fahrten
        function calculateRegularPlan() {
            const dist = parseFloat(document.getElementById('regularDistance').value);
            const count = parseInt(document.getElementById('regularCount').value, 10);
            // negative oder nicht numerische Werte sollen nicht akzeptiert werden
            if (isNaN(dist) || dist < 0 || isNaN(count) || count < 0) {
                alert('Bitte gib gültige Werte für Streckenlänge und Anzahl der Fahrten ein.');
                return;
            }
            const totalRegular = dist * count;
            let resultHtml = '<p><strong>Geplante Kilometer (regelmäßig):</strong> ' + formatKm(totalRegular) + '&nbsp;km</p>';
            let remaining = NaN;
            // Versuche, verbleibendes Monatsbudget aus localStorage zu laden
            try {
                const saved = localStorage.getItem('leasingTrackerData');
                if (saved) {
                    const obj = JSON.parse(saved);
                    if (obj.remainingMonthKm !== undefined) {
                        remaining = obj.remainingMonthKm;
                    }
                }
            } catch (e) {
                // localStorage kann deaktiviert sein – ignoriere
            }
            // Fallback: nutze den globalen Wert
            if (isNaN(remaining) && !isNaN(remainingMonthKm)) {
                remaining = remainingMonthKm;
            }
            if (!isNaN(remaining)) {
                // berücksichtige bereits geplante außerordentliche Fahrten
                const totalOneTime = plannedTrips.reduce((sum, trip) => sum + trip.total, 0);
                const remainingAfter = remaining - totalRegular - totalOneTime;
                resultHtml += '<p><strong>Restliche Kilometer nach dieser Planung (inkl. außerordentlicher Fahrten):</strong> ' + formatKm(remainingAfter) + '&nbsp;km</p>';
                if (remainingAfter >= 0) {
                    resultHtml += '<p class="success">Deine regelmäßigen Fahrten passen in dein Monatsbudget.</p>';
                } else {
                    resultHtml += '<p class="warning">Achtung: Du würdest dein Monatsbudget mit dieser Planung überschreiten.</p>';
                }
            } else {
                resultHtml += '<p><em>Keine Monatsbudgetdaten gefunden. Bitte berechne zuerst den Kilometerstand.</em></p>';
            }
            document.getElementById('regularPlanResults').innerHTML = resultHtml;
            // Aktualisiere den monatlichen Plan für den aktuellen Monat: regelmäßige Fahrten abziehen
            if (currentDateGlobal) {
                // finde Index im monthlyPlan, der dem aktuellen Monat entspricht
                const idx = monthlyPlan.findIndex(m => m.date.getFullYear() === currentDateGlobal.getFullYear() && m.date.getMonth() === currentDateGlobal.getMonth());
                if (idx >= 0) {
                    monthlyPlan[idx].regularKm = totalRegular;
                    // Differenzzelle aktualisieren, falls sichtbar
                    const diffCell = document.getElementById('monthDiff-' + idx);
                    if (diffCell) {
                        diffCell.textContent = formatKm(monthlyPlan[idx].allowedKm - monthlyPlan[idx].plannedKm - monthlyPlan[idx].regularKm);
                    }
                    updateMonthlyPlanSummary();
                    renderChart();
                    // Speichere aktualisierten Plan in localStorage
                    try {
                        const saved = localStorage.getItem('leasingTrackerData');
                        let obj = saved ? JSON.parse(saved) : {};
                        obj.monthlyPlan = monthlyPlan;
                        localStorage.setItem('leasingTrackerData', JSON.stringify(obj));
                    } catch (e) {}
                }
            }
        }

        // Initialisiert oder aktualisiert die monatliche Planungstabelle
        function initMonthlyPlan() {
            monthlyPlan = [];
            if (!startDateGlobal || isNaN(dailyLimit) || isNaN(leaseDurationGlobal)) return;
            // Lade gespeicherten Plan und Laufzeit, sofern vorhanden
            let savedPlan = null;
            try {
                const saved = localStorage.getItem('leasingTrackerData');
                if (saved) {
                    const obj = JSON.parse(saved);
                    if (obj.monthlyPlan) savedPlan = obj.monthlyPlan;
                }
            } catch (e) {}
            for (let i = 0; i < leaseDurationGlobal; i++) {
                const monthDate = new Date(startDateGlobal.getFullYear(), startDateGlobal.getMonth() + i, 1);
                const nextMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);
                const daysInMonth = Math.floor((nextMonth - monthDate) / (24 * 60 * 60 * 1000));
                const allowedKm = dailyLimit * daysInMonth;
                let plannedKm = 0;
                let actualKm = 0;
                let regularKm = 0;
                if (savedPlan && savedPlan[i]) {
                    if (!isNaN(savedPlan[i].plannedKm)) plannedKm = savedPlan[i].plannedKm;
                    if (!isNaN(savedPlan[i].actualKm)) actualKm = savedPlan[i].actualKm;
                    if (!isNaN(savedPlan[i].regularKm)) regularKm = savedPlan[i].regularKm;
                }
                // tatsächliche km nur für den aktuellen Monat, wenn Monatsstart angegeben wurde
                if (currentDateGlobal) {
                    const monthIndex = monthDate.getMonth();
                    const year = monthDate.getFullYear();
                    if (monthIndex === currentDateGlobal.getMonth() && year === currentDateGlobal.getFullYear()) {
                        const monthStartOdoVal = document.getElementById('monthStartOdometer').value;
                        if (monthStartOdoVal !== '') {
                            const monthStartOdo = parseFloat(monthStartOdoVal);
                            const currentOdo = parseFloat(document.getElementById('currentOdometer').value);
                            if (!isNaN(currentOdo) && !isNaN(monthStartOdo)) {
                                actualKm = currentOdo - monthStartOdo;
                            }
                        }
                    }
                }
                monthlyPlan.push({ allowedKm: allowedKm, plannedKm: plannedKm, actualKm: actualKm, regularKm: regularKm, date: monthDate });
            }
            // Nach dem Aufbau der Planungen die Jahresauswahl auffrischen und Tabelle für das aktuell gewählte Jahr anzeigen
            populateYearSelector();
            renderMonthlyPlanTable();
        }

        // Befüllt die Jahresauswahl basierend auf den Monaten im Plan
        function populateYearSelector() {
            const selector = document.getElementById('yearSelector');
            if (!selector) return;
            // Alle Jahre extrahieren
            const years = [];
            monthlyPlan.forEach((m) => {
                const yr = m.date.getFullYear();
                if (!years.includes(yr)) years.push(yr);
            });
            years.sort((a, b) => a - b);
            // Speichere aktuelle Auswahl
            const currentValue = selector.value;
            selector.innerHTML = '';
            years.forEach((yr) => {
                const option = document.createElement('option');
                option.value = yr;
                option.textContent = yr;
                selector.appendChild(option);
            });
            // Wähle standardmäßig das aktuelle Jahr (falls vorhanden), sonst das erste Jahr
            let defaultYear = currentDateGlobal ? currentDateGlobal.getFullYear() : years[0];
            if (!years.includes(defaultYear)) defaultYear = years[0];
            selector.value = currentValue && years.includes(parseInt(currentValue, 10)) ? currentValue : defaultYear;
            // Bei Änderung die Tabelle neu rendern
            selector.onchange = function() {
                renderMonthlyPlanTable(this.value);
            };
        }

        // Zeichnet die monatliche Planungstabelle für ein bestimmtes Jahr
        function renderMonthlyPlanTable(selectedYear) {
            const table = document.getElementById('monthlyPlanTable');
            if (!table) return;
            // Wenn Jahr nicht angegeben, nimm ausgewählten Wert aus Dropdown
            const year = selectedYear || document.getElementById('yearSelector').value;
            table.innerHTML = '';
            // Tabellenkopf
            let header = '<thead><tr><th>Monat</th><th>Erlaubt (km)</th><th>Außerordentlich (km)</th><th>Differenz (km)</th></tr></thead>';
            table.innerHTML = header;
            const tbody = document.createElement('tbody');
            monthlyPlan.forEach((m, index) => {
                if (m.date.getFullYear().toString() === year.toString()) {
                    const row = document.createElement('tr');
                    const monthName = m.date.toLocaleString('de-DE', { month: 'long', year: 'numeric' });
                    row.innerHTML =
                        '<td>' + monthName + '</td>' +
                        '<td>' + formatKm(m.allowedKm) + '</td>' +
                        // Füge Tailwind‑Klassen hinzu, damit die Eingabefelder auch im Dark‑Mode lesbar sind
                        '<td><input type="number" id="plannedKm-' + index + '" min="0" value="' + (m.plannedKm || '') + '" class="p-1 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" style="width:80%;" /></td>' +
                        '<td id="monthDiff-' + index + '">' + formatKm(m.allowedKm - m.plannedKm - m.regularKm) + '</td>';
                    tbody.appendChild(row);
                }
            });
            table.appendChild(tbody);
            // Ereignisse für die sichtbaren Eingabefelder
            monthlyPlan.forEach((m, index) => {
                const input = document.getElementById('plannedKm-' + index);
                if (input) {
                    input.addEventListener('input', function(e) {
                        const val = parseFloat(e.target.value);
                        monthlyPlan[index].plannedKm = isNaN(val) ? 0 : val;
                        const diffCell = document.getElementById('monthDiff-' + index);
                        if (diffCell) diffCell.textContent = formatKm(monthlyPlan[index].allowedKm - monthlyPlan[index].plannedKm - (monthlyPlan[index].regularKm || 0));
                        updateMonthlyPlanSummary();
                        renderChart();
                        // Speichere aktualisierten Plan
                        try {
                            const saved = localStorage.getItem('leasingTrackerData');
                            let obj = saved ? JSON.parse(saved) : {};
                            obj.monthlyPlan = monthlyPlan;
                            localStorage.setItem('leasingTrackerData', JSON.stringify(obj));
                        } catch (e) {}
                    });
                }
            });
        }

        // Aktualisiert die Zusammenfassung der monatlichen Planung
        function updateMonthlyPlanSummary() {
            const summaryDiv = document.getElementById('monthlyPlanSummary');
            if (!summaryDiv) return;
            const totalAllowed = monthlyPlan.reduce((sum, m) => sum + m.allowedKm, 0);
            const totalPlanned = monthlyPlan.reduce((sum, m) => sum + m.plannedKm, 0);
            // Differenz berücksichtigt auch regelmäßige Fahrten (regularKm)
            const totalRegular = monthlyPlan.reduce((sum, m) => sum + (m.regularKm || 0), 0);
            const diff = totalAllowed - totalPlanned - totalRegular;
            let html = '<p><strong>Jahreslimit insgesamt:</strong> ' + formatKm(totalAllowed) + '&nbsp;km</p>';
            html += '<p><strong>Geplante Kilometer im Jahr:</strong> ' + formatKm(totalPlanned) + '&nbsp;km</p>';
            html += '<p><strong>Verbleibendes Jahresbudget:</strong> ' + formatKm(diff) + '&nbsp;km</p>';
            if (diff >= 0) {
                html += '<p class="success">Deine Jahresplanung liegt im Budget.</p>';
            } else {
                html += '<p class="warning">Achtung: Deine Jahresplanung überschreitet das Budget um ' + formatKm(-diff) + '&nbsp;km.</p>';
            }
            summaryDiv.innerHTML = html;
        }

        // Zeichnet die grafische Übersicht basierend auf monthlyPlan
        function renderChart() {
            const container = document.getElementById('chartContainer');
            if (!container) return;
            container.innerHTML = '';
            if (monthlyPlan.length === 0) return;
            // Maximalwert bestimmen
            let maxVal = 0;
            monthlyPlan.forEach(m => {
                maxVal = Math.max(maxVal, m.allowedKm, m.plannedKm, m.actualKm);
            });
            if (maxVal === 0) maxVal = 1;
            // Für jeden Monat eine Zeile
            monthlyPlan.forEach((m, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'chart-row';
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = m.date.toLocaleString('de-DE', { month: 'short' });
                const bars = document.createElement('div');
                bars.className = 'chart-bars';
                // Erlaubt
                const allowedBar = document.createElement('div');
                allowedBar.className = 'bar allowed';
                allowedBar.style.width = (m.allowedKm / maxVal * 100) + '%';
                bars.appendChild(allowedBar);
                // Geplant
                const plannedBar = document.createElement('div');
                plannedBar.className = 'bar planned';
                plannedBar.style.width = (m.plannedKm / maxVal * 100) + '%';
                bars.appendChild(plannedBar);
                // Aktuell
                const actualBar = document.createElement('div');
                actualBar.className = 'bar actual';
                actualBar.style.width = (m.actualKm / maxVal * 100) + '%';
                bars.appendChild(actualBar);
                rowDiv.appendChild(label);
                rowDiv.appendChild(bars);
                container.appendChild(rowDiv);
            });
        }

        // Automatische Berechnung, wenn Pflichtfelder ausgefüllt sind
        function maybeAutoCalculate() {
            const annualLimitVal = document.getElementById('annualLimit').value;
            const startDateVal2 = document.getElementById('startDate').value;
            const startOdoVal = document.getElementById('startOdometer').value;
            const currentDateVal2 = document.getElementById('currentDate').value;
            const currentOdoVal = document.getElementById('currentOdometer').value;
            if (annualLimitVal && startDateVal2 && currentDateVal2 && startOdoVal !== '' && currentOdoVal !== '') {
                calculate();
            }
        }

        // Event‑Listener binden
        document.getElementById('addTrip').addEventListener('click', addTrip);
        // Der Button für regelmäßige Fahrten löst die monatliche Berechnung aus
        document.getElementById('calculateRegularPlan').addEventListener('click', calculateRegularPlan);
        document.getElementById('calculate').addEventListener('click', calculate);
        ['annualLimit', 'startDate', 'startOdometer', 'currentDate', 'currentOdometer', 'monthStartOdometer', 'leaseDuration'].forEach(function(id) {
            const el = document.getElementById(id);
            el.addEventListener('input', maybeAutoCalculate);
            el.addEventListener('change', maybeAutoCalculate);
        });

        // Dark‑Mode‑Toggle initialisieren: aktiviert den Dark‑Mode, wenn Schalter gesetzt ist
        const darkToggle = document.getElementById('darkToggle');
        if (darkToggle) {
            // Beim Laden prüfen, ob der Dark‑Mode in localStorage gespeichert ist
            try {
                const darkStored = localStorage.getItem('darkMode');
                if (darkStored === 'true') {
                    document.documentElement.classList.add('dark');
                    darkToggle.checked = true;
                }
            } catch (e) {
                // Zugriff auf localStorage kann im privaten Modus deaktiviert sein
            }
            // Ändert den Dark‑Mode und speichert die Auswahl
            darkToggle.addEventListener('change', function (e) {
                const isDark = e.target.checked;
                document.documentElement.classList.toggle('dark', isDark);
                try {
                    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
                } catch (err) {}
            });
        }

        // Standardwerte bei Laden der Seite setzen und gespeicherte Daten abrufen
        (function() {
            const today = new Date();
            document.getElementById('currentDate').valueAsDate = today;
            try {
                const saved = localStorage.getItem('leasingTrackerData');
                if (saved) {
                    const obj = JSON.parse(saved);
                    if (obj.annualLimit) document.getElementById('annualLimit').value = obj.annualLimit;
                    if (obj.startDate) document.getElementById('startDate').value = obj.startDate;
                    if (obj.startOdometer) document.getElementById('startOdometer').value = obj.startOdometer;
                    if (obj.currentDate) document.getElementById('currentDate').value = obj.currentDate;
                    if (obj.currentOdometer) document.getElementById('currentOdometer').value = obj.currentOdometer;
                    if (obj.monthStartOdometer) document.getElementById('monthStartOdometer').value = obj.monthStartOdometer;
                    if (obj.monthlyPlan) monthlyPlan = obj.monthlyPlan;
                    if (obj.leaseDuration) {
                        document.getElementById('leaseDuration').value = obj.leaseDuration;
                        leaseDurationGlobal = parseInt(obj.leaseDuration, 10);
                    }
                }
            } catch (e) {}
            maybeAutoCalculate();
        })();
    </script>
</body>
</html>